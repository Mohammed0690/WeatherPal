<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WeatherPal Test</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    #contextMenu button:hover {
      background: #eee;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>

  <!-- Context Menu -->
  <div id="contextMenu" style="
    position:absolute; 
    display:none; 
    background:#fff; 
    border:1px solid #ccc; 
    padding:5px; 
    z-index:1000;
    font-size:14px;">
    <button id="getCoordsBtn">Get Coordinates</button>
  </div>

  <!-- Date/Time Picker -->
  <div id="dateTimePicker" style="
    position:absolute;
    top:20px; left:20px;
    background:#fff; 
    border:1px solid #ccc; 
    padding:10px;
    display:none;
    z-index:1001;">
    <label>Select Date & Time:</label><br>
    <input type="datetime-local" id="dateTimeInput"><br><br>
    <button id="fetchWeatherBtn">Get Weather</button>
    <button onclick="document.getElementById('dateTimePicker').style.display='none'">Cancel</button>
  </div>

  <!-- Weather Output -->
  <div id="weatherOutput" style="
    position:absolute;
    bottom:20px; left:20px;
    background:#fff;
    border:1px solid #ccc;
    padding:10px;
    max-width:250px;
    display:none;
    z-index:1002;
    font-size:14px;">
  </div>

<script>
        Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiNTEzOTNjNi0wZGJlLTQ1MWEtYjZhZS00ZTAyYWMyMmI5NDAiLCJpZCI6MzQ0OTIwLCJpYXQiOjE3NTg5MDE5Mzd9.Ci93j0fixbO-lNk93PXVNW_wumpsFLzYPI4HVQdOcVY";

        // 🌍 Globe
        const viewer = new Cesium.Viewer("cesiumContainer", {
        terrainProvider: new Cesium.CesiumTerrainProvider({
            url: Cesium.IonResource.fromAssetId(1), // World Terrain
        }),
        imageryProvider: new Cesium.IonImageryProvider({
            assetId: 2, // Bing Maps Aerial imagery
        }),
        baseLayerPicker: true,
        timeline: false,
        animation: false,
        });

        viewer.scene.globe.enableLighting = true;
        viewer.scene.globe.showGroundAtmosphere = true;
        viewer.scene.globe.depthTestAgainstTerrain = true;
        viewer.camera.flyHome(2);

        let pickedCoords = null;
        let currentPin = null;

        // 📌 Right click handler
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function (movement) {
        let picked = viewer.scene.pickPosition(movement.position);
        if (!Cesium.defined(picked)) {
            const ray = viewer.camera.getPickRay(movement.position);
            picked = viewer.scene.globe.pick(ray, viewer.scene);
        }

        if (Cesium.defined(picked)) {
            const carto = Cesium.Cartographic.fromCartesian(picked);
            const lon = Cesium.Math.toDegrees(carto.longitude);
            const lat = Cesium.Math.toDegrees(carto.latitude);
            pickedCoords = { lat, lon };

            // show context menu
            const menu = document.getElementById("contextMenu");
            menu.style.left = movement.position.x + "px";
            menu.style.top = movement.position.y + "px";
            menu.style.display = "block";
        }
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

        // Hide menu
        window.addEventListener("click", () => {
        document.getElementById("contextMenu").style.display = "none";
        });

        // 📍 "Get Coordinates" clicked
        document.getElementById("getCoordsBtn").addEventListener("click", async () => {
        if (!pickedCoords) return;

        // Drop pin
        if (currentPin) viewer.entities.remove(currentPin);
        currentPin = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(pickedCoords.lon, pickedCoords.lat),
            point: {
            pixelSize: 15,
            color: Cesium.Color.RED,
            outlineColor: Cesium.Color.WHITE,
            outlineWidth: 2,
            },
        });

        // Reverse geocode
        let locationName = "Unknown location";
        try {
            const geocodeUrl = `https://api.cesium.com/v1/geocode/reverse?longitude=${pickedCoords.lon}&latitude=${pickedCoords.lat}&access_token=${Cesium.Ion.defaultAccessToken}`;
            const geoRes = await fetch(geocodeUrl);
            const geoData = await geoRes.json();
            if (geoData.features && geoData.features.length > 0) {
            locationName = geoData.features[0].place_name;
            }
        } catch (err) {
            console.warn("Geocode error:", err);
        }

        // setup datetime picker
        const now = new Date();
        const minDate = new Date(now);
        minDate.setDate(now.getDate() - 7);
        const maxDate = new Date(now);
        maxDate.setDate(now.getDate() + 7);

        const input = document.getElementById("dateTimeInput");
        input.min = minDate.toISOString().slice(0, 16);
        input.max = maxDate.toISOString().slice(0, 16);
        input.value = now.toISOString().slice(0, 16);

        document.getElementById("dateTimePicker").style.display = "block";
        document.getElementById("weatherOutput").innerHTML =
            `<b>📍 Selected Location:</b> ${locationName}<br> 
            <b>Coordinates:</b> ${pickedCoords.lat.toFixed(4)}, ${pickedCoords.lon.toFixed(4)}<br>`;
        });

        // 🌦️ Weather
        document.getElementById("fetchWeatherBtn").addEventListener("click", async () => {
        const dateTime = document.getElementById("dateTimeInput").value;
        if (!dateTime || !pickedCoords) return;

        const url = `https://api.open-meteo.com/v1/forecast?latitude=${pickedCoords.lat}&longitude=${pickedCoords.lon}&hourly=temperature_2m,precipitation,cloudcover,windspeed_10m&timezone=auto`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (!data.hourly || !data.hourly.time) {
            alert("⚠️ No weather data available.");
            return;
            }

            // find nearest hour to requested time
            const idx = data.hourly.time.findIndex(t => t.startsWith(dateTime.slice(0, 13)));
            if (idx === -1) {
            alert("⚠️ No weather data at this hour.");
            return;
            }

            const output = document.getElementById("weatherOutput");
            output.innerHTML += `
            <b>🕒 Date:</b> ${dateTime}<br>
            <b>🌡️ Temp:</b> ${data.hourly.temperature_2m[idx]}°C<br>
            <b>🌧️ Rain:</b> ${data.hourly.precipitation[idx]} mm<br>
            <b>☁️ Clouds:</b> ${data.hourly.cloudcover[idx]} %<br>
            <b>💨 Wind:</b> ${data.hourly.windspeed_10m[idx]} km/h
            `;
            output.style.display = "block";
            document.getElementById("dateTimePicker").style.display = "none";
        } catch (err) {
            console.error("Weather fetch failed:", err);
        }
        });
</script>
</body>
</html>
